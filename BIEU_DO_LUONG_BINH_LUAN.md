# BIỂU ĐỒ LUỒNG HỆ THỐNG BÌNH LUẬN

## 1. Luồng tạo bình luận mới (từ khách hàng)

```
┌─────────────────────────────────────────────────────────────────┐
│  Khách hàng viết bình luận + đánh giá sao                        │
└────────────────────────┬────────────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────────────┐
│  BinhLuan Model → boot() → creating event                        │
└────────────────────────┬────────────────────────────────────────┘
                         │
                    ┌────┴─────┐
                    │          │
                    ▼          ▼
    ┌───────────────────────────────────┐  ┌────────────────────┐
    │  ProfanityFilter::filter()        │  │  Check số sao      │
    │  Lọc từ ngữ nhạy cảm → ***        │  │                    │
    └───────────────┬───────────────────┘  └────────┬───────────┘
                    │                               │
                    │           sss                    ▼
                    │                    ┌──────────────────────┐
                    │                    │  Nếu so_sao <= 2     │
                    │                    │  trang_thai =        │
                    │                    │  'cho_duyet'         │
                    │                    └──────────┬───────────┘
                    │                               │
                    └───────────────┬───────────────┘
                                    ▼
                    ┌────────────────────────────────┐
                    │  Lưu vào Database              │
                    └────────────────────────────────┘
```

## 2. Luồng Admin xem và trả lời bình luận

```
┌─────────────────────────────────────────────────────────────────┐
│  Admin vào /admin/binhluan                                       │
└────────────────────────┬────────────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────────────┐
│  Click "Xem" (👁️) bình luận                                      │
└────────────────────────┬────────────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────────────┐
│  BinhLuanController@show                                         │
│  Load bình luận + replies + user + chuyenXe                      │
└────────────────────────┬────────────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────────────┐
│  View: show.blade.php                                            │
│  ┌────────────────────────────────────────────────────────────┐ │
│  │  📱 Chat Interface                                         │ │
│  │  ┌──────────────────────────────────────────────────────┐ │ │
│  │  │  👤 Khách hàng: "Xe chạy chậm quá"                   │ │ │
│  │  │     ⭐⭐ (2 sao) [Chờ duyệt]                         │ │ │
│  │  └──────────────────────────────────────────────────────┘ │ │
│  │                                                            │ │
│  │  ┌──────────────────────────────────────────────────────┐ │ │
│  │  │              👨‍💼 Admin: "Xin lỗi, chúng tôi sẽ cải   │ │ │
│  │  │                          thiện tốc độ"               │ │ │
│  │  └──────────────────────────────────────────────────────┘ │ │
│  │                                                            │ │
│  │  ┌──────────────────────────────────────────────────────┐ │ │
│  │  │  📝 [Nhập câu trả lời...]                            │ │ │
│  │  │  [Gửi trả lời] [Xóa]                                 │ │ │
│  │  └──────────────────────────────────────────────────────┘ │ │
│  └────────────────────────────────────────────────────────────┘ │
└────────────────────────┬────────────────────────────────────────┘
                         │
                         ▼
                  [Admin nhập reply]
                         │
                         ▼
┌─────────────────────────────────────────────────────────────────┐
│  POST /admin/binhluan/{id}/reply                                 │
│  BinhLuanController@reply                                        │
└────────────────────────┬────────────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────────────┐
│  Validate input                                                  │
│  ProfanityFilter::filter() → lọc từ cấm                          │
└────────────────────────┬────────────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────────────┐
│  Tạo BinhLuan mới:                                               │
│  - parent_id = ID bình luận gốc                                  │
│  - user_id = auth()->id()                                        │
│  - nv_id = auth()->id()                                          │
│  - trang_thai = 'da_duyet' (auto approved)                       │
│  - so_sao = 0 (reply không có rating)                            │
└────────────────────────┬────────────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────────────┐
│  Redirect back với message: "Đã gửi trả lời thành công!"        │
└─────────────────────────────────────────────────────────────────┘
```

## 3. Luồng Duyệt/Từ chối bình luận

```
┌─────────────────────────────────────────────────────────────────┐
│  Admin xem bình luận có trang_thai = 'cho_duyet'                 │
└────────────────────────┬────────────────────────────────────────┘
                         │
                    ┌────┴─────┐
                    │          │
                    ▼          ▼
    ┌───────────────────────┐  ┌──────────────────────┐
    │  Click "Duyệt"        │  │  Click "Từ chối"     │
    └───────────┬───────────┘  └──────────┬───────────┘
                │                         │
                ▼                         ▼
┌─────────────────────────────┐  ┌────────────────────────────┐
│  POST approve()             │  │  POST reject()             │
│  - trang_thai = 'da_duyet'  │  │  - trang_thai = 'tu_choi'  │
│  - ngay_duyet = now()       │  │  - ly_do_tu_choi = input   │
│  - nv_id = auth()->id()     │  │                            │
└─────────────┬───────────────┘  └──────────┬─────────────────┘
              │                             │
              └──────────────┬──────────────┘
                             ▼
              ┌───────────────────────────────┐
              │  Update database              │
              │  Redirect với thông báo       │
              └───────────────────────────────┘
```

## 4. Cấu trúc Database Relationships

```
┌────────────────────────────────────────────────────────────────┐
│  binh_luan                                                      │
├────────────────────────────────────────────────────────────────┤
│  ma_bl (PK)                                                     │
│  parent_id (FK to ma_bl) ◄─────┐                               │
│  user_id (FK to users)          │                               │
│  chuyen_xe_id (FK)              │                               │
│  noi_dung                       │ [Self-referential]            │
│  so_sao                         │ parent() / replies()          │
│  trang_thai                     │                               │
│  nv_id (FK to users)            │                               │
└─────────────┬───────────────────┘                               │
              │                                                   │
              │ Bình luận GỐC: parent_id = NULL                   │
              │ ├─ Reply 1: parent_id = {ma_bl của bình luận gốc} │
              │ ├─ Reply 2: parent_id = {ma_bl của bình luận gốc} │
              │ └─ Reply 3: parent_id = {ma_bl của bình luận gốc} │
              │                                                   │
              └───────────────────────────────────────────────────┘

Ví dụ:
┌─────────────────────────────────────────┐
│  ma_bl=1, parent_id=NULL                │  ← Bình luận gốc
│  "Xe rất tốt" ⭐⭐⭐⭐⭐                   │
└─────────────┬───────────────────────────┘
              │
              ├─ ┌──────────────────────────────────┐
              │  │  ma_bl=2, parent_id=1            │  ← Reply 1
              │  │  "Cảm ơn bạn!"                   │
              │  └──────────────────────────────────┘
              │
              └─ ┌──────────────────────────────────┐
                 │  ma_bl=3, parent_id=1            │  ← Reply 2
                 │  "Bạn đi ngày nào vậy?"          │
                 └──────────────────────────────────┘
```

## 5. Profanity Filter Logic

```
┌─────────────────────────────────────────────────────────────────┐
│  Input: "Xe này đm rất tệ, fuck this"                            │
└────────────────────────┬────────────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────────────┐
│  ProfanityFilter::normalizeVietnamese()                          │
│  "xe nay dm rat te, fuck this" (lowercase, no tone marks)        │
└────────────────────────┬────────────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────────────┐
│  Loop qua từng từ trong $profanityWords array                    │
│  ['đm', 'dm', 'fuck', 'shit', ...]                               │
└────────────────────────┬────────────────────────────────────────┘
                         │
                    ┌────┴─────┐
                    │          │
                    ▼          ▼
    ┌──────────────────────┐  ┌─────────────────────┐
    │  Match: "dm"         │  │  Match: "fuck"      │
    │  Replace: "**"       │  │  Replace: "****"    │
    └──────────┬───────────┘  └──────────┬──────────┘
               │                         │
               └────────────┬────────────┘
                            ▼
┌─────────────────────────────────────────────────────────────────┐
│  Output: "Xe này ** rất tệ, **** this"                           │
└─────────────────────────────────────────────────────────────────┘
```

## 6. Auto-moderation Decision Tree

```
                    [Bình luận mới được tạo]
                              │
                              ▼
                    ┌──────────────────┐
                    │  parent_id = ?   │
                    └────────┬─────────┘
                             │
                        ┌────┴────┐
                        │         │
                    NULL│         │NOT NULL
                        │         │
                        ▼         ▼
            ┌───────────────┐  ┌──────────────────┐
            │  Bình luận gốc│  │  Reply           │
            └───────┬───────┘  │  → Skip auto-    │
                    │          │     moderation   │
                    ▼          └──────────────────┘
            ┌───────────────┐
            │  so_sao = ?   │
            └───────┬───────┘
                    │
         ┌──────────┼──────────┐
         │          │          │
        ≤2         3-5      undefined
         │          │          │
         ▼          ▼          ▼
┌─────────────┐  ┌──────────┐  ┌─────────────┐
│ cho_duyet   │  │ da_duyet │  │  da_duyet   │
│ (cần duyệt) │  │ (auto OK)│  │  (default)  │
└─────────────┘  └──────────┘  └─────────────┘
```

## 7. UI Component Breakdown

```
show.blade.php
├── Header (Breadcrumb)
├── Success/Error Messages
├── Row
    ├── Col-md-8 (Main content)
    │   ├── Card: Chat Box
    │   │   ├── Header: Title + Badge (số tin nhắn)
    │   │   ├── Body: Chat Messages
    │   │   │   ├── Original Comment (left)
    │   │   │   │   ├── Avatar
    │   │   │   │   ├── Name + Timestamp
    │   │   │   │   ├── Content + Rating
    │   │   │   │   └── Status badge
    │   │   │   └── Replies (alternating left/right)
    │   │   │       ├── Customer (left, gray)
    │   │   │       └── Admin (right, green)
    │   │   └── Footer: Reply Form
    │   │       ├── Textarea
    │   │       └── Buttons (Send, Clear)
    │   └── Card: Approval Actions (if pending)
    │       ├── Button: Approve
    │       └── Button: Reject (opens modal)
    │
    └── Col-md-4 (Sidebar)
        ├── Card: Trip Info
        │   ├── Route (Di → Den)
        │   └── Details (Date, Time)
        ├── Card: Customer Info
        │   ├── Avatar
        │   └── Details (Name, Email, Phone)
        └── Card: Actions
            ├── Back button
            └── Delete button

Modal: Reject Reason
├── Header
├── Body: Textarea (ly_do_tu_choi)
└── Footer: Cancel, Reject buttons
```

---

**Tóm tắt**: Hệ thống tự động lọc từ cấm, kiểm duyệt đánh giá thấp, và cung cấp giao diện chat thân thiện cho admin tương tác với khách hàng.
